<Project ToolsVersion="15.0">

  <PropertyGroup>
    <XdtRoot Condition="'$(XdtRoot)' == ''">..\</XdtRoot>
  </PropertyGroup>
  
  <PropertyGroup>
    <PackageId>Microsoft.Web.Xdt</PackageId>
    <Authors>Microsoft Corporation</Authors>
    <Title>Microsoft Xml Document Transformation</Title>
    <Description>Microsoft Xml Document Transformation (XDT) enables transformig XML files. This is the same technology used to transform web.config files for Visual Studio web projects.</Description>
    <Copyright>Â© Microsoft Corporation. All rights reserved.</Copyright>
    <PackageRequireLicenseAcceptance>true</PackageRequireLicenseAcceptance>
    <PackageLicenseUrl>https://www.microsoft.com/web/webpi/eula/net_library_eula_enu.htm</PackageLicenseUrl>
    <PackageProjectUrl>https://github.com/aspnet/xdt</PackageProjectUrl>
    <PackageIconUrl></PackageIconUrl>
    <PackageTags>Microsoft Xdt XmlDocumentTransform XmlTransform</PackageTags>
    <PackageReleaseNotes></PackageReleaseNotes>
    <RepositoryUrl>https://github.com/aspnet/xdt</RepositoryUrl>
    <RepositoryType>git</RepositoryType>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(PackageVersion)' == '' ">
    <!-- If $(PB_VersionStamp) is empty and $(PB_IsStable) is not true, then a default PackageBuildQuality will be added. -->
    <PackageReleaseVersion Condition="'$(PackageReleaseVersion)' == '' ">3.0.0</PackageReleaseVersion>
    <PackageBuildQuality>$(PB_VersionStamp)</PackageBuildQuality>
    <PackageBuildQuality Condition=" '$(PackageBuildQuality)' == '' And '$(PB_IsStable)' != 'true' ">preview1</PackageBuildQuality>
    <PackageDateTime Condition="'$(PackageDateTime)' == ''">$([System.DateTime]::Now.ToString("yyyyMMdd"))</PackageDateTime>
    <PackageBuildNumber Condition="'$(PackageBuildNumber)' == ''">0</PackageBuildNumber>
    <PackageBuildNumber Condition="'$(PackageBuildNumber)' == '0' And '$(BUILD_BUILDNUMBER)' != ''">$(BUILD_BUILDNUMBER)</PackageBuildNumber>

    <AssemblyReleaseVersion>$(PackageReleaseVersion).$([MSBuild]::Modulo($(PackageBuildNumber), 65535))</AssemblyReleaseVersion>

    <PackageVersion>$(PackageReleaseVersion)</PackageVersion>
    <PackageVersion Condition="'$(PackageBuildQuality)' != ''">$(PackageReleaseVersion)-$(PackageBuildQuality)</PackageVersion>
    <PackageVersion Condition="'$(PB_IsStable)' != 'true'">$(PackageVersion)-$(PackageDateTime)-$(PackageBuildNumber)</PackageVersion>
  </PropertyGroup>

  <PropertyGroup>
    <GenerateAssemblyInfo Condition="'$(BuildingInsideVisualStudio)' != ''">False</GenerateAssemblyInfo>
    <GenerateAssemblyFileVersionAttribute>False</GenerateAssemblyFileVersionAttribute>
    <GenerateAssemblyVersionAttribute>False</GenerateAssemblyVersionAttribute>
    <GenerateAssemblyInformationalVersionAttribute>False</GenerateAssemblyInformationalVersionAttribute>
  </PropertyGroup>

  <PropertyGroup>
    <AssemblyOriginatorKeyFile>$(XdtRoot)\tools\Key.snk</AssemblyOriginatorKeyFile>
    <SignAssembly>true</SignAssembly>
    <DelaySign>true</DelaySign>
  </PropertyGroup>

  <PropertyGroup>
    <ArtifactsDir>$(XdtRoot)\artifacts\</ArtifactsDir>
    <GitInfoFile>$(ArtifactsDir)GitInfo.cs</GitInfoFile>
    <GitInfoProps>$(ArtifactsDir)GitInfo.props</GitInfoProps>
  </PropertyGroup>

  <Target Name="CollectGitInfo">
    <PropertyGroup>
      <GitInfoCommitCount Condition="'$(COMMIT_HASH)' != ''">$(COMMIT_COUNT)</GitInfoCommitCount>
      <GitInfoCommitHash Condition="'$(COMMIT_HASH)' != ''">$(COMMIT_HASH)</GitInfoCommitHash>
      <GitExitCode>0</GitExitCode>
    </PropertyGroup>

    <Exec Command="git rev-list --count HEAD" ConsoleToMSBuild="true" Condition="'$(COMMIT_HASH)' == ''" IgnoreExitCode="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="GitInfoCommitCount" />
      <Output TaskParameter="ExitCode" PropertyName="GitInfoCommitCountExitCode" />
    </Exec>

    <Exec Command="git rev-parse HEAD" ConsoleToMSBuild="true" Condition="'$(COMMIT_HASH)' == ''" IgnoreExitCode="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="GitInfoCommitHash" />
      <Output TaskParameter="ExitCode" PropertyName="GitInfoCommitHashExitCode" />
    </Exec>

    <PropertyGroup Condition="'$(GitInfoCommitCountExitCode)' != '0'">
      <GitInfoCommitCount>0</GitInfoCommitCount>
    </PropertyGroup>

    <PropertyGroup Condition="'$(GitInfoCommitHashExitCode)' != '0'">
      <GitInfoCommitHash>UNKNOWN</GitInfoCommitHash>
    </PropertyGroup>

    <PropertyGroup>
      <GitCommitInfoContent>
        <![CDATA[
[assembly: System.Reflection.AssemblyVersion("$(AssemblyReleaseVersion)")]
[assembly: System.Reflection.AssemblyFileVersion("$(AssemblyReleaseVersion)")]
[assembly: System.Reflection.AssemblyInformationalVersion("$(PackageVersion)+$(GitInfoCommitCount).$(GitInfoCommitHash)")]

namespace Microsoft.Web.XmlTransform
{
    internal static class GitInfo
    {
        public static string PackageVersion { get%3B } = "$(PackageVersion)"%3B
        public static string CommitCount { get%3B } = "$(GitInfoCommitCount)"%3B
        public static string CommitHash { get%3B } = "$(GitInfoCommitHash)"%3B
    }
}
]]>
      </GitCommitInfoContent>
      <GitInfoPropsContent>
        <![CDATA[
<Project ToolsVersion="15.0">
  <PropertyGroup>
    <Version>$(PackageReleaseVersion)</Version>
    <FileVersion>$(PackageReleaseVersion)</FileVersion>
    <InformationalVersion>$(PackageVersion)+$(GitInfoCommitCount).$(GitInfoCommitHash)</InformationalVersion>
    <PackageReleaseNotes>Commit Hash: $(GitInfoCommitHash)</PackageReleaseNotes>
  </PropertyGroup>
</Project>
]]>
      </GitInfoPropsContent>
    </PropertyGroup>

    <WriteLinesToFile File="$(GitInfoFile)"
                      Lines="$(GitCommitInfoContent)"
                      Overwrite="true" />

    <WriteLinesToFile File="$(GitInfoProps)"
                      Lines="$(GitInfoPropsContent)"
                      Overwrite="true" />
  </Target>

  <ItemGroup>
    <Compile Include="$(GitInfoFile)" Condition="Exists('$(GitInfoFile)')" Link="%(RecursiveDir)%(Filename)%(Extension)" />
    <Compile Include="$(XdtRoot)/src/GitInfo.cs" Condition="!Exists('$(GitInfoFile)')" Link="%(RecursiveDir)%(Filename)%(Extension)" />

  </ItemGroup>

  <Import Project="$(GitInfoProps)" Condition="Exists('$(GitInfoProps)')" />
</Project>
